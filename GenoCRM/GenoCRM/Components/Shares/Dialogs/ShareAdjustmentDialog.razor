@using GenoCRM.Models.Domain
@using GenoCRM.Services.Business
@using GenoCRM.Services.Localization
@using GenoCRM.Services.UI
@using System.ComponentModel.DataAnnotations
@inject IShareService ShareService
@inject IStringLocalizer<GenoCRM.SharedResource> SharedLocalizer
@inject IFormattingService FormattingService

<div class="modal fade show d-block" tabindex="-1" role="dialog" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@SharedLocalizer["AdjustShares"] - @_share?.CertificateNumber</h5>
                <button type="button" class="btn-close" @onclick="OnCancel"></button>
            </div>
            <div class="modal-body">
                @if (_share != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">@SharedLocalizer["CurrentShareDetails"]</h6>
                                    <p><strong>@SharedLocalizer["Member"]:</strong> @_share.Member?.FullName</p>
                                    <p><strong>@SharedLocalizer["Quantity"]:</strong> @_share.Quantity</p>
                                    <p><strong>@SharedLocalizer["ValuePerShare"]:</strong> @FormattingService.FormatCurrency(_share.Value)</p>
                                    <p><strong>@SharedLocalizer["TotalValue"]:</strong> @FormattingService.FormatCurrency(_share.TotalValue)</p>
                                    <p><strong>@SharedLocalizer["PaidAmount"]:</strong> @FormattingService.FormatCurrency(_share.PaidAmount)</p>
                                    <p><strong>@SharedLocalizer["OutstandingAmount"]:</strong> @FormattingService.FormatCurrency(_share.OutstandingAmount)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">@SharedLocalizer["NewShareDetails"]</h6>
                                    <p><strong>@SharedLocalizer["Quantity"]:</strong> @_adjustmentModel.NewQuantity</p>
                                    <p><strong>@SharedLocalizer["ValuePerShare"]:</strong> @FormattingService.FormatCurrency(_share.Value)</p>
                                    <p><strong>@SharedLocalizer["TotalValue"]:</strong> @FormattingService.FormatCurrency(_newTotalValue)</p>
                                    <p><strong>@SharedLocalizer["PaidAmount"]:</strong> @FormattingService.FormatCurrency(_share.PaidAmount)</p>
                                    <p><strong>@SharedLocalizer["OutstandingAmount"]:</strong>
                                        <span class="@GetOutstandingAmountClass()">@FormattingService.FormatCurrency(_newOutstandingAmount)</span>
                                    </p>
                                    @if (_newOutstandingAmount < 0)
                                    {
                                        <small class="text-info">@SharedLocalizer["OverpaidRefundNote"]</small>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        @SharedLocalizer["ShareAdjustmentNote"]
                    </div>

                    @if (_adjustmentDifference > 0)
                    {
                        <div class="alert alert-success">
                            <i class="fas fa-plus-circle"></i>
                            @string.Format(SharedLocalizer["ShareIncreaseNote"], _adjustmentDifference, FormattingService.FormatCurrency(_valueDifference))
                        </div>
                    }
                    else if (_adjustmentDifference < 0)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-minus-circle"></i>
                            @string.Format(SharedLocalizer["ShareDecreaseNote"], Math.Abs(_adjustmentDifference), FormattingService.FormatCurrency(Math.Abs(_valueDifference)))
                        </div>
                    }

                    <EditForm Model="_adjustmentModel" OnValidSubmit="HandleAdjustment">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger" />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">@SharedLocalizer["NewQuantity"]</label>
                                    <InputNumber class="form-control" @bind-Value="_adjustmentModel.NewQuantity" @onchange="RecalculateValues" min="0" max="@_maxAllowedShares" />
                                    <small class="form-text text-muted">
                                        @SharedLocalizer["MaximumAllowed"]: @_maxAllowedShares
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">@SharedLocalizer["AdjustmentDate"]</label>
                                    <InputDate class="form-control" @bind-Value="_adjustmentModel.AdjustmentDate" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">@SharedLocalizer["Reason"]</label>
                            <InputTextArea class="form-control" @bind-Value="_adjustmentModel.Reason" rows="3" placeholder="@SharedLocalizer["AdjustmentReason"]" />
                        </div>

                        @if (_newOutstandingAmount < 0)
                        {
                            <div class="alert alert-warning">
                                <h6>@SharedLocalizer["RefundRequired"]</h6>
                                <p>@string.Format(SharedLocalizer["RefundRequiredNote"], FormattingService.FormatCurrency(Math.Abs(_newOutstandingAmount)))</p>
                                <div class="form-check">
                                    <InputCheckbox class="form-check-input" @bind-Value="_adjustmentModel.ProcessRefund" id="processRefund" />
                                    <label class="form-check-label" for="processRefund">
                                        @SharedLocalizer["ProcessRefundAutomatically"]
                                    </label>
                                </div>
                            </div>
                        }

                        <div class="form-check mb-3">
                            <InputCheckbox class="form-check-input" @bind-Value="_adjustmentModel.ConfirmAdjustment" id="confirmAdjustment" />
                            <label class="form-check-label" for="confirmAdjustment">
                                <strong>@SharedLocalizer["ConfirmShareAdjustment"]</strong>
                            </label>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" @onclick="OnCancel">
                                @SharedLocalizer["Cancel"]
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@(_isProcessing || !_adjustmentModel.ConfirmAdjustment)">
                                @if (_isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                @SharedLocalizer["AdjustShares"]
                            </button>
                        </div>
                    </EditForm>
                }
                else
                {
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">@SharedLocalizer["Loading"]</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int ShareId { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<bool> OnComplete { get; set; }

    private CooperativeShare? _share;
    private ShareAdjustmentModel _adjustmentModel = new();
    private int _maxAllowedShares = 100;
    private bool _isProcessing = false;

    // Calculated values
    private decimal _newTotalValue => _adjustmentModel.NewQuantity * (_share?.Value ?? 0);
    private decimal _newOutstandingAmount => _newTotalValue - (_share?.PaidAmount ?? 0);
    private int _adjustmentDifference => _adjustmentModel.NewQuantity - (_share?.Quantity ?? 0);
    private decimal _valueDifference => _newTotalValue - (_share?.TotalValue ?? 0);

    protected override async Task OnInitializedAsync()
    {
        await LoadShare();
    }

    private async Task LoadShare()
    {
        try
        {
            _share = await ShareService.GetShareByIdAsync(ShareId);
            if (_share != null)
            {
                _adjustmentModel = new ShareAdjustmentModel
                {
                    NewQuantity = _share.Quantity,
                    AdjustmentDate = DateTime.Today,
                    Reason = $""
                };
                // TODO: Get max shares from configuration or member service
                _maxAllowedShares = 100 - _share.Quantity + _share.Quantity; // Placeholder logic
            }
        }
        catch (Exception)
        {
            // Error handling will be done by parent component
        }
    }

    private void RecalculateValues()
    {
        // This will trigger the reactive calculations
        StateHasChanged();
    }

    private string GetOutstandingAmountClass()
    {
        return _newOutstandingAmount switch
        {
            > 0 => "text-warning",
            < 0 => "text-info",
            _ => "text-success"
        };
    }

    private async Task HandleAdjustment()
    {
        if (_share == null) return;

        try
        {
            _isProcessing = true;

            // Create a copy of the share with adjusted quantity
            var adjustedShare = new CooperativeShare
            {
                Id = _share.Id,
                MemberId = _share.MemberId,
                CertificateNumber = _share.CertificateNumber,
                Quantity = _adjustmentModel.NewQuantity,
                NominalValue = _share.NominalValue,
                Value = _share.Value,
                IssueDate = _share.IssueDate,
                Status = _share.Status,
                Notes = string.IsNullOrEmpty(_share.Notes)
                    ? _adjustmentModel.Reason
                    : $"{_share.Notes}\n\n[{_adjustmentModel.AdjustmentDate:yyyy-MM-dd}] {_adjustmentModel.Reason}",
                CreatedAt = _share.CreatedAt,
                UpdatedAt = DateTime.UtcNow,
                CancellationDate = _share.CancellationDate
            };

            await ShareService.UpdateShareAsync(adjustedShare);

            // TODO: If refund is required and requested, create refund payment
            if (_newOutstandingAmount < 0 && _adjustmentModel.ProcessRefund)
            {
                // This would require extending PaymentService to handle refunds
                // For now, we'll just note it in the share notes
            }

            await OnComplete.InvokeAsync(true);
        }
        catch (Exception)
        {
            await OnComplete.InvokeAsync(false);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private class ShareAdjustmentModel
    {
        [Required]
        [Range(0, int.MaxValue, ErrorMessage = "Quantity must be 0 or greater")]
        public int NewQuantity { get; set; }

        [Required]
        public DateTime AdjustmentDate { get; set; } = DateTime.Today;

        [Required]
        public string Reason { get; set; } = string.Empty;

        public bool ProcessRefund { get; set; } = false;

        [Required]
        [Range(typeof(bool), "true", "true", ErrorMessage = "You must confirm the adjustment")]
        public bool ConfirmAdjustment { get; set; } = false;
    }
}